# ============================================
# RENDER.COM DEPLOYMENT CONFIGURATION
# All 11 microservices + Database + Redis
# ============================================

services:
  # ============================================
  # 1. API GATEWAY (Port 3000)
  # ============================================
  - type: web
    name: studyspot-gateway
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/api-gateway/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: studyspot-redis
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: CORS_ORIGIN
        value: https://admin.studyspot.com,https://owner.studyspot.com
    healthCheckPath: /health

  # ============================================
  # 2. AUTH SERVICE (Port 3001)
  # ============================================
  - type: web
    name: studyspot-auth
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/auth-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: studyspot-redis
          property: connectionString
      - key: JWT_SECRET
        sync: false
      - key: JWT_REFRESH_SECRET
        sync: false
    healthCheckPath: /health

  # ============================================
  # 3. USER SERVICE (Port 3002)
  # ============================================
  - type: web
    name: studyspot-user
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/user-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 4. TENANT SERVICE (Port 3003)
  # ============================================
  - type: web
    name: studyspot-tenant
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/tenant-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 5. STUDENT SERVICE (Port 3004)
  # ============================================
  - type: web
    name: studyspot-student
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/student-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 6. LIBRARY SERVICE (Port 3005)
  # ============================================
  - type: web
    name: studyspot-library
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/library-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 7. PAYMENT SERVICE (Port 3006)
  # ============================================
  - type: web
    name: studyspot-payment
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/payment-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
      - key: CASHFREE_APP_ID
        sync: false
      - key: CASHFREE_SECRET_KEY
        sync: false
      - key: CASHFREE_API_VERSION
        value: 2023-08-01
      - key: RAZORPAY_KEY_ID
        sync: false
      - key: RAZORPAY_KEY_SECRET
        sync: false
    healthCheckPath: /health

  # ============================================
  # 8. CREDIT SERVICE (Port 3008)
  # ============================================
  - type: web
    name: studyspot-credit
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/credit-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 9. SUBSCRIPTION SERVICE (Port 3009)
  # ============================================
  - type: web
    name: studyspot-subscription
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/subscription-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

  # ============================================
  # 10. MESSAGING SERVICE (Port 3011)
  # ============================================
  - type: web
    name: studyspot-messaging
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/messaging-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: studyspot-redis
          property: connectionString
      - key: MSG91_AUTH_KEY
        sync: false
      - key: MSG91_SENDER_ID
        value: STDYSP
      - key: MSG91_ROUTE
        value: 4
      - key: BSNL_ENTITY_ID
        sync: false
    healthCheckPath: /health

  # ============================================
  # 11. ANALYTICS SERVICE (Port 3013)
  # ============================================
  - type: web
    name: studyspot-analytics
    env: node
    region: singapore
    plan: free
    rootDir: backend
    buildCommand: npm install && npm run build
    startCommand: node dist/services/analytics-service/index.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: studyspot-postgres
          property: connectionString
    healthCheckPath: /health

# ============================================
# DATABASES
# ============================================
databases:
  - name: studyspot-postgres
    databaseName: studyspot_core
    user: studyspot
    plan: free
    region: singapore
    ipAllowList: []

  - name: studyspot-redis
    plan: free
    region: singapore
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

